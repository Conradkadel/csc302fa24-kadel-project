<!DOCTYPE html>
<!--
Index/Dashboard Page for Stock/Crypto Viewer
Author: Conrad Kadel

Description:
This is the dashboard page that users see after signing in. It provides navigation options to view friends, perform stock/crypto searches, and change settings.
It also contains a favorite stocks table and current market trends.
Citations:
  - Class Code ( Quizzer )
  - AI (Styles)
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles/mainStyle.css">
    <link rel="stylesheet" href="styles/dashboard.css">
    <script src="Objects/Stock.js"></script>
    <script src="Objects/Crypto.js"></script>
    <title>Dashboard - Stock/Crypto Viewer</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <style>
        /* Modal styles were helped with by AI to create the Sing UP page */
        /* Modal styles for both Sign-In and Sign-Up */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1; /* Sit on top */
            padding-top: 100px; /* Location of the box */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            background-color: rgba(0,0,0,0.5); /* Black background with opacity */
        }

        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border: 1px solid #888;
            width: 300px;
            position: relative;
        }

        .close {
            color: #aaa;
            position: absolute;
            right: 10px;
            top: 10px;
            font-size: 28px;
            font-weight: bold;
        }

        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        #market-news-section {
            margin: 20px 0;
            padding: 20px;
            background-color: #f9f9f9;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .news-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .news-card {
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            width: calc(33% - 50px);
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
        }

        .news-card h3 {
            font-size: 18px;
            margin-bottom: 10px;
        }

        .news-card p {
            margin: 5px 0;
            font-size: 14px;
        }

        .news-card img {
            margin-bottom: 10px;
            border-radius: 8px;
        }


    </style>
</head>
<script>
    //Event Listener on Page Load that check Sign in right away and if user is not 
    // programm will make him sign in
    // Helped by AI to fix issues with HTML displays
    document.addEventListener("DOMContentLoaded", async () => {
        await checkSignedIn();
        // Add event listener for switching from sign-in to sign-up
        document.getElementById('switch-to-signup').addEventListener('click', function(event) {
            event.preventDefault();
            // Hide sign-in modal and show sign-up modal
            document.getElementById('sign-in-modal').style.display = 'none';
            document.getElementById('sign-up-modal').style.display = 'block';
        });

        // Close modals when the close buttons are clicked
        document.getElementById('close-signin').addEventListener('click', function() {
            document.getElementById('sign-in-modal').style.display = 'none';
        });

        document.getElementById('close-signup').addEventListener('click', function() {
            document.getElementById('sign-up-modal').style.display = 'none';
        });

        // Close modals when clicking outside the modal content
        window.onclick = function(event) {
            if (event.target == document.getElementById('sign-in-modal')) {
                document.getElementById('sign-in-modal').style.display = 'none';
            }
            if (event.target == document.getElementById('sign-up-modal')) {
                document.getElementById('sign-up-modal').style.display = 'none';
            }
        };
        await fetchFavorites();
        await getMarketInfo(); 
    });

    async function fetchFavorites() {
        console.log("STEP !");
        try {
            const response = await fetch('/src/backEnd/api.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'action=getUserFavorites',
            });

            if (!response.ok) {
                throw new Error('Failed to fetch favorites');
            }
            
            const data = await response.json();
            console.log("STEP 2", data);
            let favorite;
            if (data.success) {
                const favoritesTable = document.querySelector('.favorites-table tbody');
                favoritesTable.innerHTML = ''; // Clear previous entries
                console.log("STEP 3");
                for (favorite of data.favorites) {
                    console.log("Favorite before fetchStockData:", favorite.isCrypto);
                    let stockData;
                    if(favorite.isCrypto == true) {
                        stockData = await Crypto.fetchCryptoData(favorite.ticker);
                    } else {
                        stockData = await Stock.fetchStockData(favorite.ticker, "1min");
                    }
                    console.log("Stock Data:", stockData.isCrypto);

                    const row = document.createElement('tr');
                    if(stockData.isCrypto == "crypto")
                    {
                        row.innerHTML = `
                        <a href="stockViewer.html?symbol=${encodeURIComponent(stockData.symbol)}&type=${encodeURIComponent(stockData.isCrypto)}">
                            ${favorite.ticker}
                        </a>
                        <td>$${stockData.currentPrice}</td>
                    `;
                    favoritesTable.appendChild(row);
                    }
                    else{
                        row.innerHTML = `
                        <a href="stockViewer.html?symbol=${encodeURIComponent(stockData.symbol)}&type=${encodeURIComponent(stockData.isCrypto)}">
                            ${favorite.ticker}
                        </a>
                        <td>$${stockData.marketCap}</td>
                    `;
                    favoritesTable.appendChild(row);
                    }
                   
                }
            } else {
                console.error('Failed to fetch favorites:', data.error);
            }
        } catch (error) {
            console.error('Error fetching favorites:', error);
        }
    }



    async function getMarketInfo()
    {
        console.log("Get market infi");
        try {
            const response = await fetch('/src/backEnd/api.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'action=getMarketInfo',
            });

            if (!response.ok) {
                throw new Error('Failed to fetch favorites');
            }

            const data = await response.json();

            console.log("STEP 2", data.feed);
            
            displayMarketNews(data.feed);
         
        } catch (error) {
            console.error('Error fetching market info:', error);
        }
    }

    function displayMarketNews(feed) {
        const newsContainer = document.getElementById('news-container');
        newsContainer.innerHTML = ''; // Clear any previous content

        feed.forEach(item => {
            const newsCard = document.createElement('div');
            newsCard.classList.add('news-card');

            // News Title with Link
            const title = document.createElement('h3');
            const link = document.createElement('a');
            link.href = item.url;
            link.textContent = item.title;
            link.target = '_blank'; // Open in a new tab
            title.appendChild(link);

            // Summary
            const summary = document.createElement('p');
            summary.textContent = item.summary;

            // Sentiment Label
            const sentiment = document.createElement('p');
            sentiment.innerHTML = `<strong>Overall Sentiment:</strong> ${item.overall_sentiment_label}`;

            // Ticker Sentiments (make tickers clickable)
            const tickers = document.createElement('ul');
            tickers.innerHTML = '<strong>Ticker Sentiments:</strong>';
            item.ticker_sentiment.forEach(ticker => {
                const tickerItem = document.createElement('li');

                // Create a clickable link for each ticker
                const tickerLink = document.createElement('a');
                tickerLink.href = item.url; // Use the same link as the news article
                tickerLink.textContent = ticker.ticker;
                tickerLink.target = '_blank'; // Open in a new tab

                tickerItem.appendChild(tickerLink);
                tickerItem.innerHTML += ` - ${ticker.ticker_sentiment_label} (${ticker.ticker_sentiment_score})`;
                tickers.appendChild(tickerItem);
            });

            // Banner Image
            if (item.banner_image) {
                const image = document.createElement('img');
                image.src = item.banner_image;
                image.alt = item.title;
                image.style.width = '100%';
                image.style.borderRadius = '8px';
                newsCard.appendChild(image);
            }

            // Append elements to the news card
            newsCard.appendChild(title);
            newsCard.appendChild(summary);
            newsCard.appendChild(sentiment);
            newsCard.appendChild(tickers);

            // Append the news card to the container
            newsContainer.appendChild(newsCard);
        });
    }



    // function that just cheches if User is signed in
    function checkSignedIn() {
        const username = localStorage.getItem('username');

        if (username) {
            console.log("User is signed in as:", username);
            // Hide the authentication modals and display the main content
            document.getElementById('sign-in-modal').style.display = 'none';
            document.getElementById('sign-up-modal').style.display = 'none';
            document.getElementById('main-content').style.display = 'block';
        } else {
            console.log("User is not signed in");
            // Show the sign-in modal if the user is not signed in
            document.getElementById('sign-in-modal').style.display = 'block';
            document.getElementById('main-content').style.display = 'none';
        }
    }

  
    // Function to handle user sign-in
    async function handleSignIn() {
        const username = document.getElementById('sign-in-username').value.trim();
        const password = document.getElementById('sign-in-password').value;

        if (username && password) {
            try {
                // Send sign-in data to api.php
                const response = await fetch('/src/backEnd/api.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `action=signIn&username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}`
                });

                if (!response.ok) {
                    throw new Error('Failed to sign in');
                }

                const data = await response.json();

                console.log(data);
                if (data.success) {
                    // Store the JWT in localStorage if sign-in is successful
                    localStorage.setItem('username', username); // Optional: store the username as well
                    console.log("User signed in successfully");

                    // Hide the sign-in modal and show the main content
                    document.getElementById('sign-in-modal').style.display = 'none';
                    document.getElementById('main-content').style.display = 'block';
                } else {
                    alert('Sign-in failed: ' + data.message);
                }
            } catch (error) {
                console.error("Error during sign-in:", error);
                alert("An error occurred during sign-in. Please try again.");
            }
        } else {
            alert('Please enter both a username and password.');
        }
    }

    // Function to handle user sign-up (This one remains largely the same but differnt call to BE)

    async function handleSignUp() {
        const username = document.getElementById('sign-up-username').value.trim();
        const password = document.getElementById('sign-up-password').value;

        if (username && password) {
            try {
                // Send sign-up data to api.php
                const response = await fetch('/src/backEnd/api.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `action=addUser&username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}`
                });

                if (!response.ok) {
                    throw new Error('Failed to sign up');
                }

                const data = await response.json();
                console.log(data);
                if (data.success) {
                    // Store the username in localStorage if sign-up is successful
                    localStorage.setItem('username', username);
                    console.log("User signed up successfully");

                    // Hide the sign-up modal and show the main content
                    document.getElementById('sign-up-modal').style.display = 'none';
                    document.getElementById('main-content').style.display = 'block';
                } else {
                    alert('Sign-up failed: ' + data.message);
                }
            } catch (error) {
                console.error("Error during sign-up:", error);
                alert("An error occurred during sign-up. Please try again.");
            }
        } else {
            alert('Please enter both a username and password.');
        }
    }


</script>
<body>
    <header>
        <h1>Dashboard - Stock/Crypto Viewer</h1>
        <div class="navigation-container">
            <nav class="navigation">
                <!-- <a href="friendPage.html">Friends</a> -->
                <a href="searchPage.html">Search</a>
                <a href="settings.html">Settings</a>
            </nav>
            <a href="profile.html" class="profile-tab">
                <img src="https://via.placeholder.com/40" alt="Profile Picture">
            </a>
        </div>
    </header>

    <div class="container">

        <!-- Sign-In Modal -->
        <div id="sign-in-modal" class="modal">
            <div class="modal-content">
                <span class="close" id="close-signin">&times;</span>
                <h2>Sign In</h2>
                <form id="login-form">
                    Username: <input type="text" id="sign-in-username" name="username" required/><br/>
                    Password: <input type="password" id="sign-in-password" name="password" required/><br/>
                    <input type="button" value="Sign In" onclick="handleSignIn()"/>
                    <p>Don't have an account? <a href="#" id="switch-to-signup">Sign Up</a></p>
                </form>
            </div>
        </div>

        <!-- Sign-Up Modal -->
        <div id="sign-up-modal" class="modal">
            <div class="modal-content">
                <span class="close" id="close-signup">&times;</span>
                <h2>Sign Up</h2>
                <form id="signup-form">
                    Username: <input type="text" id="sign-up-username" name="username" required/><br/>
                    Password: <input type="password" id="sign-up-password" name="password" required/><br/>
                    <input type="button" value="Sign Up" onclick="handleSignUp()"/>
                </form>
            </div>
        </div>
        <!-- Main Content -->
        <div id="main-content" style="display: none;">
            <div class="dashboard">
                <section id="market-news-section">
                    <h2>Market News</h2>
                    <div id="news-container" class="news-grid">
                        <!-- News items will be dynamically inserted here -->
                    </div>
                </section>
                
                
                <!--Favourtie not updating depending on DB entries of user-->
                <section class="favorites-table">
                    <h2>Your Favorites</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>Asset</th>
                                <th>Market Cap / Price</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Filled by JavaScript after fetching data -->
                        </tbody>
                    </table>
                </section>
                
            </div>
        </div>
    </div>
</body>
</html>

