<!DOCTYPE html>
<!--
Stock Viewer Page for Stock/Crypto Viewer
Author: Conrad Kadel

Description:
This page displays detailed information about a stock/cryptocurrency based on the user's search.
The page includes a graph powered by TradingView's lightweight charts and allows the user to add a stock to their favorites list.
Citations:
- TradingView lightweight charts (https://tradingview.github.io/lightweight-charts/)
- Fetch API help (https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API/Using_Fetch)
-->

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles/mainStyle.css">
    <link rel="stylesheet" href="styles/stockViewer.css">
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <script src="Objects/Stock.js"></script>
    <script src="Objects/Crypto.js"></script>
    <title>Stock Viewer</title>
    <style>
        /* Styles for the back button */
        .back-button {
            position: absolute;
            top: 20px; /* Adjust to fit within the header */
            left: 20px;
            padding: 10px 20px;
            font-size: 16px;
            border: none;
            background-color: #f5f5f5; /* Match the color scheme */
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .back-button:hover {
            background-color: #ddd;
        }
    </style>
</head>
<script>
    let symbol; 
    let stock;
    // Add favorites Function
    async function addFavourite() {
        try {
            const response = await fetch('../backEnd/api.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `action=addFavouriteStock&symbol=${encodeURIComponent(symbol)}&isCrypto=${encodeURIComponent(stock.isCrypto)}`
            });

            const data = await response.json();
            if (data.success) {
                alert('Stock added to favourites successfully!');
            } else {
                alert('Failed to add stock to favourites.' + data.message);
            }
        } catch (error) {
            console.error('Error adding stock to favourites:', error);
            alert('An error occurred while adding the stock to favourites. Please try again later.');
        }
    }

    // Load the page with relevant stock/crypto data
    document.addEventListener("DOMContentLoaded", async () => {
        const urlParams = new URLSearchParams(window.location.search);
        symbol = urlParams.get('symbol');
        const type = urlParams.get('type');
        const interval = '15min';

        console.log("Symbol from URL:", symbol);
        console.log("Type from URL:", type);


        if (symbol) {
            if (type === "stock") {
                console.log("Stock");
                stock = await Stock.fetchStockData(symbol, interval);
            } else if (type === "crypto") {
                console.log("Crypto");
                stock = await Crypto.fetchCryptoData(symbol);
            } else {
                console.error("Invalid type specified in URL");
                return;
            }

            if (stock) {
                console.log("SETTING");
                // Update UI elements with fetched data
                document.getElementById("stock-symbol").textContent = stock.symbol || "N/A";

                if (type === "crypto") {
                    // Update UI for cryptocurrencies
                    document.getElementById("company-name").textContent = stock.symbol || "N/A";
                    document.getElementById("market-cap").textContent = `Current Price: $${stock.currentPrice || "N/A"}`;
                    document.getElementById("pe-ratio").style.display = 'none';
                    document.getElementById("dividend-yield").style.display = 'none';
                    document.getElementById("company-description").style.display = 'none';

                    // Disable interval selector if necessary
                    document.getElementById('interval-selector').disabled = true;
                } else {
                    // Update UI for stocks
                    document.getElementById("company-name").textContent = stock.name || "N/A";
                    document.getElementById("market-cap").textContent = `Market Cap: $${stock.marketCap || "N/A"}`;
                    document.getElementById("pe-ratio").textContent = `P/E Ratio: ${stock.peRatio || "N/A"}`;
                    document.getElementById("dividend-yield").textContent = `Dividend Yield: ${stock.dividendYield || "N/A"}`;
                    document.getElementById("company-description").textContent = stock.description || "N/A";

                    // Ensure elements are visible
                    document.getElementById("pe-ratio").style.display = 'block';
                    document.getElementById("dividend-yield").style.display = 'block';
                    document.getElementById("company-description").style.display = 'block';

                    // Enable interval selector
                    document.getElementById('interval-selector').disabled = false;
                }

                // Update stock price to the latest closing price
                const timestamps = Object.keys(stock.timeSeries);
                if (timestamps.length > 0) {
                    const latestTimestamp = timestamps[0];
                    const latestData = stock.timeSeries[latestTimestamp];
                    console.log("Timestamps:", timestamps);

                    document.getElementById("stock-price").textContent = `$${latestData["4. close"] || "N/A"}`;
                    document.getElementById("price-change").textContent = `Last Close: ${latestTimestamp}`;
                } else {
                    document.getElementById("stock-price").textContent = "N/A";
                    document.getElementById("price-change").textContent = "No data available";
                }

                // Update chart data
                updateChart(stock.timeSeries);
            } else {
                console.log("NO SETTING");
                alert("Stock data not found. Please check the symbol and try again.");
                window.location.href = 'searchPage.html';
            }
        } else {
            console.error("No stock symbol found in URL");
        }
    });

    // Function to update the chart
    function updateChart(timeSeries) {
        if (!timeSeries || Object.keys(timeSeries).length === 0) {
            console.error("No time series data available.");
            return;
        }

        const chartData = Object.keys(timeSeries).map(timestamp => {
            // Parse timestamp to UNIX time
            let parsedTime = Date.parse(timestamp.replace(' ', 'T')) / 1000;
            if (isNaN(parsedTime)) {
                console.error("Invalid timestamp:", timestamp);
                return null;
            }

            const dataPoint = timeSeries[timestamp];

            const openField = "1. open";
            const highField = "2. high";
            const lowField = "3. low";
            const closeField = "4. close";

            return {
                time: parsedTime,
                open: parseFloat(dataPoint[openField]),
                high: parseFloat(dataPoint[highField]),
                low: parseFloat(dataPoint[lowField]),
                close: parseFloat(dataPoint[closeField]),
            };
        }).filter(dataPoint => dataPoint !== null);

        chartData.sort((a, b) => a.time - b.time);

        const chartContainer = document.getElementById('chart');
        chartContainer.innerHTML = '';

        const chart = LightweightCharts.createChart(chartContainer, {
            width: chartContainer.clientWidth,
            height: 400,
            layout: {
                backgroundColor: '#ffffff',
                textColor: '#333',
            },
            grid: {
                vertLines: {
                    color: '#eee',
                },
                horzLines: {
                    color: '#eee',
                },
            },
            crosshair: {
                mode: LightweightCharts.CrosshairMode.Normal,
            },
            rightPriceScale: {
                borderColor: '#ccc',
            },
            timeScale: {
                borderColor: '#ccc',
            },
        });

        const candleSeries = chart.addCandlestickSeries();
        candleSeries.setData(chartData);
    }

    // Update data based on selected interval
    async function changeInterval() {
        const interval = document.getElementById('interval-selector').value;
        const type = new URLSearchParams(window.location.search).get('type');

        if (type === "stock") {
            const stockData = await Stock.fetchStockData(symbol, interval);
            if (stockData) {
                updateChart(stockData.timeSeries);
            }
        } else if (type === "crypto") {
            const cryptoData = await Crypto.fetchCryptoData(symbol);
            if (cryptoData) {
                updateChart(cryptoData.timeSeries);
            }
        }
    }

</script>

<body>
    <div class="container">
        <header class="dashboard-header">
            <h1>Stock Viewer</h1>
            <button class="back-button" onclick="window.location.href='index.html';">&#8592; Back to Dashboard</button>
        </header>

        <main class="content">
            <button class="favorite-button" onclick="addFavourite()" title="Add to Favorites">&#9733;</button>
            <section class="stock-summary">
                <h2 id="stock-symbol">Loading...</h2>
                <h3 id="company-name">Loading...</h3>
                <div class="stock-price">
                    <h3 id="stock-price">Loading...</h3>
                    <span id="price-change">Loading...</span>
                </div>
            </section>

            <section class="stock-info">
                <h3>Overview</h3>
                <ul id="stock-overview">
                    <li id="market-cap">Loading...</li>
                    <li id="pe-ratio">Loading...</li>
                    <li id="dividend-yield">Loading...</li>
                </ul>
                <p id="company-description">Loading...</p>
            </section>

            <section class="graph">
                <h3>Price Graph</h3>
                <label for="interval-selector">Select Interval:</label>
                <select id="interval-selector" onchange="changeInterval()">
                    <option value="1min">1 Minute</option>
                    <option value="5min">5 Minutes</option>
                    <option value="15min" selected>15 Minutes</option>
                    <option value="30min">30 Minutes</option>
                    <option value="60min">60 Minutes</option>
                    <option value="1day">1 Day</option>
                </select>
                <div id="chart" class="graph-placeholder" style="height: 400px;"></div>
            </section>

            <section class="resources">
                <h3>Useful Links</h3>
                <ul>
                    <li><a href="https://finance.yahoo.com">Yahoo Finance</a></li>
                    <li><a href="https://www.google.com/finance">Google Finance</a></li>
                    <li><a href="https://seekingalpha.com">Seeking Alpha</a></li>
                    <li><a href="https://www.apple.com">Official Website</a></li>
                </ul>
            </section>
        </main>

        <footer class="dashboard-footer">
            <p>&copy; 2024 Stock Viewer App</p>
        </footer>
    </div>
</body>
</html>
